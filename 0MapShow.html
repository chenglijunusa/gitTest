<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no">
    
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Maps Toolbar</title>
    
    <link rel="stylesheet" href="https://js.arcgis.com/3.16/dijit/themes/nihilo/nihilo.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.16/esri/css/esri.css">

    <style>
      html, body, #mainWindow {
        font-family: sans-serif; 
        height: 100%; 
        width: 100%; 
      }
      html, body {
        margin: 0; 
        padding: 0;
      }
      #header {
        height: 80px; 
        overflow: auto;
        padding: 0.5em;
      }
    </style>
    

    <script src="https://js.arcgis.com/3.16/"></script>
      
       <script src="scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
      <script src="scripts/jquery.selectboxes.min.js" type="text/javascript"></script>
    <script src="Scripts/jquery.tablesorter.js" type="text/javascript"></script>
       <script src="Scripts/LeeChengTools.js"></script>

       <script src="scripts/jquery.selectboxes.min.js" type="text/javascript"></script>
     

    <script>
        var toolbar, symbol, geomTask;
        var map_click_handle;
        var map, queryTask, query;
        var infoTemplate;
        var ExtentFull;
        var smallX = 99999, smallY = 9999, bigX = -9999, bigY = -9999;
        var map_click_handle;

        $(document).ready(function () {

        
          
            //$("#idStateNameSearch").hide();
            $("#idStateABBRSearch").hide();
            
            require([
              "esri/map",
              "esri/toolbars/draw",
              "esri/graphic",

              "esri/symbols/SimpleMarkerSymbol",
              "esri/symbols/SimpleLineSymbol",
              "esri/symbols/SimpleFillSymbol",

              "dojo/parser", "dijit/registry",

              "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
              "dijit/form/Button", "dijit/WidgetSet", "dojo/domReady!"
            ], function (
              Map, Draw, Graphic,
              SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
              parser, registry
            ) {
                parser.parse();

                //map = new Map("map", {
                //    basemap: "streets",
                //    center: [-15.469, 36.428],
                //    zoom: 3
                //});
              
                map = new esri.Map("map");
                symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));

                //create and add new layer
                var layer = new esri.layers.ArcGISDynamicMapServiceLayer("https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer");
                map.addLayer(layer);

                map.on("load", createToolbar);
                ExtentFull = map.getExtent;
                // loop through all dijits, connect onClick event
                // listeners for buttons to activate drawing tools

                registry.forEach(function (d) {
                    // d is a reference to a dijit
                    // could be a layout container or a button
                    if (d.declaredClass === "dijit.form.Button") {
                        d.on("click", activateTool);
                    }
                });

                function activateTool() {
                    var tool = this.label.toUpperCase().replace(/ /g, "_");
                    map.infoWindow.hide();
                    dojo.disconnect(map_click_handle);
                    map.graphics.clear();
                 //   $("#idStateNameSearch").hide();
                    $("#idStateABBRSearch").hide();
                    
                    toolbar.activate(Draw[tool]);
                    map.hideZoomSlider();
                }


                function createToolbar(themap) {
                    map.graphics.clear();
                    map.infoWindow.hide();
                    dojo.disconnect(map_click_handle);
                    toolbar = new Draw(map);
                    toolbar.on("draw-end", addToMap);
                }

                function addToMap(evt) {
                    var symbol;
                    map.graphics.clear();
                    map.infoWindow.hide();
                    
                    var tt = evt.geometry.type;

                    toolbar.deactivate();
                    map.showZoomSlider();
                    switch (evt.geometry.type) {
                        case "point":
                        case "multipoint":
                            symbol = new SimpleMarkerSymbol();
                            map.graphics.clear();
                            map.infoWindow.hide();
                            dojo.disconnect(map_click_handle);
                      //      $("#idStateNameSearch").hide();
                            $("#idStateABBRSearch").hide();
                          map_click_handle = dojo.connect(map, "onClick", executeQueryTask);

                            break;
                        case "polyline":
                            symbol = new SimpleLineSymbol();
                            break;
                        default:
                            symbol = new SimpleFillSymbol();
                            break;
                    }
                    var graphic = new Graphic(evt.geometry, symbol);
                    map.graphics.add(graphic);

                    //build query task
                    queryTask = new esri.tasks.QueryTask("https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/1");

                    //Can listen for onComplete event to process results or can use the callback option in the queryTask.execute method.
                    //dojo.connect(queryTask, "onComplete", showResults);

                    //build query filter
                    query = new esri.tasks.Query();
                    query.returnGeometry = true;
                    //query.outFields = ["STATE_NAME", "STATE_FIPS", "STATE_ABBR", "HYPERLINK", "AREA"];
                    query.outFields = ["*"];
                
                    query.returnGeometry = true;

                    // query.outFields = ["SITUS_DIR", "SITUS_NUMBER", "SITUS_STREET", "SITUS_TYPE", "COUNCIL_DISTRICTS_COUNCILDIS", "GNOCDC_LAB", "GEOPIN", "OWNER_FIRST", "OWNER_LAST", "OWNER_MIDNAME", "TAX_BILL", "GIS_ADDRESS"];

                    query.spatialRelationship = esri.tasks.Query.SPATIAL_REL_INTERSECTS;
                    query.geometry = graphic.geometry;
                    queryTask.execute(query, showResults);


                }
                function showResults(featureSet) {
               
                var sCookie = "<table><tr><td style='bgcolor:#D9D9D9;font-size:14;text-align:center'>State Name</td><td style='font-size:14;text-align:center'>Population</td></tr>";
               //     var sCookie = "";

                    // map.infoWindow.resize(895, 75);
                    var s = "<table>";

                    for (var i = 0, il = featureSet.features.length; i < il; i++) {


                        var graphic = featureSet.features[i];

                        graphic.setSymbol(symbol);
                        var fExtent = graphic.geometry.getExtent();
                        var centerP = fExtent.getCenter();
                        var xx = centerP.x;
                        var yy = centerP.y;

                        if (smallX >= xx) {
                            smallX = xx;
                        }

                        if (bigX < xx) {
                            bigX = xx;
                        }


                        if (smallY >= yy) {
                            smallY = yy;

                        }

                        if (bigY < yy) {
                            bigY = yy;

                        }
                          var ss2 = graphic.attributes['STATE_ABBR'];
                       // sCookie = sCookie + "<tr><td style='font-size:12'>" + graphic.attributes.STATE_NAME + "</td><td style='font-size:12'>" + graphic.attributes.POP1990 + "</td></tr>";
                       sCookie =  graphic.attributes.STATE_NAME + "/" + graphic.attributes.POP1990 ;

                       s = s + "<tr><td>State Name:</td><td>Population</td></tr><tr><td>" + graphic.attributes.STATE_NAME + "</td><td>" + graphic.attributes.POP1990 + "</td></tr>";
                        map.graphics.add(graphic);
                    }
                  s = s+ "<tr><td></td><td><button onclick='getExcel()'>Get Excel</button> </td></tr></table>";

                
                    
                    document.cookie = "myReport=" + sCookie;                 

                    var env = new esri.geometry.Extent(smallX, smallY, bigX, bigY, new esri.SpatialReference({ wkid: 4326 }));

                    map.setExtent(env);
                    var sp1 = map.toScreen(env.getCenter());
                    map.infoWindow.setContent(s);
                    map.infoWindow.setTitle("");
                    
                   

                    map.infoWindow.show(sp1, map.getInfoWindowAnchor(sp1));



                }
           

                $("#cmdIdentity").click(function () {
                    map.graphics.clear();
                    map.infoWindow.hide();
                    dojo.disconnect(map_click_handle);
                  //  $("#idStateNameSearch").hide();
                    $("#idStateABBRSearch").hide();
                    map_click_handle = dojo.connect(map, "onClick", executeQueryTask);
                });


                $("#cmdStateNameSearch").click(function () {
                    map.graphics.clear();                  
                    map.infoWindow.hide();
                    dojo.disconnect(map_click_handle);
                    $("#idStateABBRSearch").hide();
                //    $("#idStateNameSearch").show();
                });

                $("#cmdStateABBRSearch").click(function () {
                    map.graphics.clear();                 
                    map.infoWindow.hide();
                 //   $("#idStateNameSearch").hide();
                    dojo.disconnect(map_click_handle);
                    $("#idStateABBRSearch").show();
                });

                $("#idGO").click(function () {
                    dojo.disconnect(map_click_handle);
                    var stateName = $("#txtStateNameSearch").val();                               

                    queryTask = new esri.tasks.QueryTask("https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/1");

                    query = new esri.tasks.Query();
                    query.returnGeometry = true;
                    //query.outFields = ["STATE_NAME", "STATE_FIPS", "STATE_ABBR", "HYPERLINK", "AREA"];
                    query.outFields = ["*"];

                    query.where = "STATE_NAME = '" + stateName + "'";
                                 
                    symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));

                    //Execute task and call showResults on completion
                    queryTask.execute(query, StateNameSearch);
                });


                $("#idABBRGo").click(function () {

                    var stateName = $("#txtStateABBRSearch").val();
                    stateName = stateName.toUpperCase();
                    //alert(stateName);


                    queryTask = new esri.tasks.QueryTask("https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/1");

                    query = new esri.tasks.Query();
                    query.returnGeometry = true;
                    //query.outFields = ["STATE_NAME", "STATE_FIPS", "STATE_ABBR", "HYPERLINK", "AREA"];
                    query.outFields = ["*"];

                    query.where = "STATE_ABBR = '" + stateName + "'";

                    symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));

                    //Execute task and call showResults on completion
                    queryTask.execute(query, StateNameSearch);
                });

            });

        
        

            function executeQueryTask(evt) {

                map.graphics.clear();
                map.infoWindow.hide();
               

                //build query task
                queryTask = new esri.tasks.QueryTask("https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/1");

                
                query = new esri.tasks.Query();
                query.returnGeometry = true;
             
                query.outFields = ["*"];             

                symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));


                query.geometry = evt.mapPoint;

                //Execute task and call showResults on completion
                queryTask.execute(query, showResults2);
            }

            function showResults2(featureSet) {
                //remove all graphics on the maps graphics layer
                

                var graphic = featureSet.features[0];

                var fExtent = graphic.geometry.getExtent();

                var centerP = fExtent.getCenter();


                graphic.setSymbol(symbol);

                //Set the infoTemplate.


                //Add graphic to the map graphics layer.
                map.graphics.add(graphic);

                var StateABBR = graphic.attributes.STATE_ABBR;
                var sp1 = map.toScreen(centerP);
                var s = "<br/>state name:" + graphic.attributes.STATE_NAME + " <br/> population:" + graphic.attributes.POP1990;

                map.infoWindow.setContent(s);
                map.infoWindow.setTitle(graphic.attributes.STATE_NAME);
                map.infoWindow.show(sp1, map.getInfoWindowAnchor(sp1));
            }


            function StateNameSearch(result) {
            //    $("#idStateNameSearch").hide();
                map.graphics.clear();

                map.infoWindow.hide();
                var graphic = result.features[0];

                var fExtent = graphic.geometry.getExtent();
                var centerP = fExtent.getCenter();

                graphic.setSymbol(symbol);

                map.graphics.add(graphic);

                var StateABBR = graphic.attributes.STATE_ABBR;



                var sp1 = map.toScreen(centerP);

                var sCityID = "";
                var sCityName = "";


               // alert(StateABBR);


                // var myProduct = getCookie("ProductID");
               // document.cookie = "myFoot=" + sFoot;

                $.ajax({

                    type: "POST",

                    url: "CarService.asmx/MapTest",

                    data: "{STATE_ABBR: '" + StateABBR + "'}",

                    contentType: "application/json; charset=utf-8",

                    dataType: "json",

                    success: function (response) {


                        var cars = response.d;

                        sCityID = cars[0][0].Value;
                        sCityName = cars[0][1].Value;

                        var s = "<br/>population:" + graphic.attributes.POP1990 + " <br/> state name:" + graphic.attributes.STATE_NAME + " <br/> Famous City:" + sCityName ;
                        map.infoWindow.setContent(s);
                        map.infoWindow.setTitle(graphic.attributes.STATE_NAME);
                        map.infoWindow.show(sp1, map.getInfoWindowAnchor(sp1));

                        map.setExtent(fExtent);

                        //map.centerAt(centerP);
                        // map.setLevel(22);



                    }

                });



            }
        });
        function getExcel() {

           // window.open('\E_ENT.html', '_blank');
            window.open('0Excel.aspx', '_blank');

            map.graphics.clear();
            map.infoWindow.hide();
            dojo.disconnect(map_click_handle);
         //   $("#idStateNameSearch").hide();
            $("#idStateABBRSearch").hide();
           
        }
    </script>
  </head>
  <body class="nihilo">

  <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline'">

    <div id="header" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'" style="height:30px">     

         <button data-dojo-type="dijit/form/Button">Point</button>
        
           <button data-dojo-type="dijit/form/Button">Polygon</button>   
      <button data-dojo-type="dijit/form/Button">Freehand Polyline</button>
      <button data-dojo-type="dijit/form/Button">Freehand Polygon</button>      
      <button data-dojo-type="dijit/form/Button">Arrow</button>
      <button data-dojo-type="dijit/form/Button">Triangle</button>

              <input id="cmdStateABBRSearch" type="button" value="State ABBR Search" style="background-color:lightskyblue; border-width:2px; height:30px"/>

    </div>
    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"></div>
  </div>
       <div id="idStateABBRSearch" style="position:absolute;left:500px; top:150px; background-color:lightyellow; border-color:black;border-width:1px; width:460px;height:35px; z-index: 888;font-size:medium"> Please entry State Name ABBR: <input id="txtStateABBRSearch" type="text" />  <input id="idABBRGo" type="button" value="GO" /></div>
  </body>
</html>
 